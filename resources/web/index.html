<html>
	<head>
		<title>Play me the Hits</title>

		<script type="text/javascript" src="static/jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="static/fuse.min.js"></script>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
		<link rel="stylesheet" href="static/pure-min.css" crossorigin="anonymous">
		<link rel="stylesheet" href="static/layout.css" crossorigin="anonymous">

	</head>

	<body>

		<!--
						<div class="pure-u-1-2">
							<form class="pure-form">
								<input type="filter" placeholder="filter" id="filter">
							</form>
						</div>
						<div class="pure-u-1-2">
							<span id="currentsong">no song</span>
						</div>
		-->

				<div class="content">
					<div class="l-box"><span class="l-big">Play me the hits</span></div>

					<div class="pure-g">
						<div class="pure-u-1-5">
							<div class="l-box">
								<table class="pure-table pure-table-horizontal" id="playlists">
									<tbody>
									</tbody>
								</table>
							</div>
						</div>
						<div class="pure-u-4-5">
							<div class="l-box">
								<table class="pure-table pure-table-horizontal" id="playlist">
									<tbody>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>

		<!--
		<div id="layout">
			<div id="main">
				<div class="content">

					<h2 class="content-subhead">Play me the hits</h2>

					<div class="pure-g">
						<div class="pure-u-1-2">
							<form class="pure-form">
								<input type="filter" placeholder="filter" id="filter">
							</form>
						</div>
						<div class="pure-u-1-2">
							<span id="currentsong">no song</span>
						</div>
					</div>

					<table class="pure-table pure-table-horizontal" id="albums">
						<tbody>
						</tbody>
					</table>

				</div>
			</div>
		</div>

		-->

		<script type="text/javascript">

var playlists;
var currently_selected_playlist = -1;

function populatePlaylists() {
	var tbody = jQuery("#playlists tbody");
	var j = 0;

	console.log("updating with playlist ver " + playlists.version);
	tbody.empty();
	$.each( playlists.playlists, function( i, playlist ) {
		var prefix = "";
		if( i == currently_selected_playlist ) { prefix = "&gt;"; }
		var x = $("<tr><td class=\"icon\">" + prefix + "</td><td><a href=\"javascript:selectPlaylist(" + i + ");\">" + playlist.name + "</a></td></tr>");
		tbody.append( x );
	});
}

function populatePlaylist() {
	var tbody = jQuery("#playlist tbody");
	var j = 0;

	tbody.empty();
	$.each( playlists.playlists[currently_selected_playlist].items, function( i, item ) {
		var prefix = "";
		var x = $("<tr><td class=\"icon\">" + prefix + "</td><td><a href=\"javascript:play(" + currently_selected_playlist + ", " + i + ");\">" + item.path + "</td></tr>");
		tbody.append( x );
	});
}

function refreshPlaylists() {
	$.getJSON("/playlists")
		.then(function(data) {
			playlists = data;
			populatePlaylists();
			populatePlaylist();
		});
}

function selectPlaylist(id) {
	currently_selected_playlist = id;
	populatePlaylist();
}

function play(playlist_id, track_id) {
	$.post( "/play?playlist=" + playlist_id + "&track=" + track_id, function( data ) { });
}


//var albums, playlists;
//$.when(
//    $.getJSON("/albums", function(data) {
//        albums = data;
//    }),
//    $.getJSON("/playlists", function(data) {
//        playlists = data;
//    })
//).then(function() {
//});
//
//
//var albums = [];
//$.getJSON( "/albums", function( data ) {
//	albums = data.albums;
//	$.each( albums, function( i, album ) {
//		album.id = i;
//	});
//	populateTable("");
//});
//
//var fuse_options = {
//	shouldSort: true,
//	threshold: 0.6,
//	location: 0,
//	distance: 100,
//	maxPatternLength: 32,
//	minMatchCharLength: 1,
//	keys: [
//		"artist",
//		"name"
//	]
//};
//
//var matches = [];
//function populateTable(filter) {
//	var tbody = jQuery("#albums tbody");
//	var j = 0;
//	matches = [];
//	if( filter == "" ) {
//		matches = albums;
//	} else {
//		var fuse = new Fuse(albums, fuse_options);
//		matches = fuse.search(filter);
//	}
//
//	if( current_selection >= matches.length ) {
//		current_selection = matches.length - 1;
//	}
//
//	tbody.empty();
//	$.each( matches, function( i, album ) {
//		var prefix = "";
//		if( i == current_selection ) {
//			prefix = "&gt; ";
//		}
//		var x = $("<tr><td class=\"icon\">" + prefix + "</td><td>" + album.artist + "</td><td>" + album.name + "</td></tr>");
//		tbody.append( x );
//	});
//}
//
//var current_selection = 0;
//$("#filter").keydown(function(e) {
//	switch(e.which) {
//		case 38: // up
//			current_selection = Math.max( current_selection-1, 0 );
//			break;
//
//		case 40: // down
//			current_selection++;
//			break;
//
//		case 13: // down
//			console.log("play song");
//			var album = matches[current_selection];
//			$.post( "/albums?album=" + album.id, function( data ) { });
//
//			break;
//
//		default:
//
//			current_selection = 0;
//			return; // exit this handler for other keys
//	}
//	e.preventDefault(); // prevent the default action (scroll / move caret)
//});
//
//
//$("#filter").keyup(function() {
//	populateTable(this.value);
//});
//
//$("#filter").attr("autocomplete", "off");
//$("#filter").select();
//
//function updateCurrentSong(msg) {
//	$("#currentsong").text(msg);
//}
//
//updateCurrentSong("nothing");
//

var first_msg = true;
var last_msg;
function updatePlaying(msg) {
	last_msg = msg;
	if( !playlists || msg.playlist_version != playlists.version ) {
		if( first_msg ) {
			first_msg = false;
			currently_selected_playlist = msg.playlist_id;
		}
		refreshPlaylists();
	}
}

function createWebsocket() {
	var exampleSocket = new WebSocket("ws://" + document.domain + ':' + location.port + "/websocket");
	exampleSocket.onopen = function (event) {
		console.log("websocket opened");
	}
	exampleSocket.onmessage = function (event) {
		console.log("got message: " + event.data);
		if( event.data == "" ) {
			return;
		}
		var msg = JSON.parse(event.data);
		updatePlaying(msg);
		//updateCurrentSong(msg.artist + " - " + msg.title);
	}
}

$(document).ready(function() {
	createWebsocket();

});

		</script>

	</body>
</html>

