<html>
	<head>
		<title>Play me the Hits</title>

		<script type="text/javascript" src="static/jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="static/fuse.min.js"></script>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
		<link rel="stylesheet" href="static/pure-min.css" crossorigin="anonymous">
		<link rel="stylesheet" href="static/layout.css" crossorigin="anonymous">

	</head>

	<body>


		<div id="layout">
			<div id="main">
				<div class="content">

					<h2 class="content-subhead">Play me the hits</h2>

					<div class="pure-g">
						<div class="pure-u-1-2">
							<form class="pure-form">
								<input type="filter" placeholder="filter" id="filter">
							</form>
						</div>
						<div class="pure-u-1-2">
							<span id="currentsong">no song</span>
						</div>
					</div>

					<table class="pure-table pure-table-horizontal" id="albums">
						<tbody>
						</tbody>
					</table>

				</div>
			</div>
		</div>

		<script type="text/javascript">

var albums = [];
$.getJSON( "/albums", function( data ) {
	albums = data.albums;
	$.each( albums, function( i, album ) {
		album.id = i;
	});
	populateTable("");
});

var fuse_options = {
	shouldSort: true,
	threshold: 0.6,
	location: 0,
	distance: 100,
	maxPatternLength: 32,
	minMatchCharLength: 1,
	keys: [
		"artist",
		"name"
	]
};

var matches = [];
function populateTable(filter) {
	var tbody = jQuery("#albums tbody");
	var j = 0;
	matches = [];
	if( filter == "" ) {
		matches = albums;
	} else {
		var fuse = new Fuse(albums, fuse_options);
		matches = fuse.search(filter);
	}

	if( current_selection >= matches.length ) {
		current_selection = matches.length - 1;
	}

	tbody.empty();
	$.each( matches, function( i, album ) {
		var prefix = "";
		if( i == current_selection ) {
			prefix = "&gt; ";
		}
		var x = $("<tr><td class=\"icon\">" + prefix + "</td><td>" + album.artist + "</td><td>" + album.name + "</td></tr>");
		tbody.append( x );
	});
}

var current_selection = 0;
$("#filter").keydown(function(e) {
	switch(e.which) {
		case 38: // up
			current_selection = Math.max( current_selection-1, 0 );
			break;

		case 40: // down
			current_selection++;
			break;

		case 13: // down
			console.log("play song");
			var album = matches[current_selection];
			$.post( "/albums?album=" + album.id, function( data ) { });

			break;

		default:

			current_selection = 0;
			return; // exit this handler for other keys
	}
	e.preventDefault(); // prevent the default action (scroll / move caret)
});


$("#filter").keyup(function() {
	populateTable(this.value);
});

$("#filter").attr("autocomplete", "off");
$("#filter").select();

function updateCurrentSong(msg) {
	$("#currentsong").text(msg);
}

updateCurrentSong("nothing");

$(document).ready(function() {

	var exampleSocket = new WebSocket("ws://" + document.domain + ':' + location.port + "/websocket");
	exampleSocket.onopen = function (event) {
		console.log("websocket opened");
	}
	exampleSocket.onmessage = function (event) {
		console.log(event.data);
	}

});

		</script>

	</body>
</html>

